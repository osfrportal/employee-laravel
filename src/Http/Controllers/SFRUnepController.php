<?php

namespace Osfrportal\OsfrportalLaravel\Http\Controllers;

use Osfrportal\OsfrportalLaravel\Interfaces\SFRx509Interface;
use Osfrportal\OsfrportalLaravel\Models\SfrPerson;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;
use Osfrportal\OsfrportalLaravel\Enums\CertsTypesEnum;
use Illuminate\Support\Facades\Log;

class SFRUnepController extends Controller
{
    //private SFRx509Interface $interface;
    public function __construct(private SFRx509Interface $interface)
    {
        $this->interface = $interface;
    }
    private function searchPidBySnils(string $snils)
    {
        $person = SfrPerson::where('psnils', $snils)->firstOr(['pid'], function () {
            $person['pid'] = null;
            return $person;
        });
        return $person['pid'];
    }

    public function test()
    {
        $xmldata = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxFbnZlbG9wZSB4bWxucz0idXJuOmVudmVsb3BlIj48Qm9keT48RGF0YSBpZD0iZGF0YVRvU2lnbiI+PHBvcnRhbFVzZXI+UGxlc2hrb3ZQQTwvcG9ydGFsVXNlcj48cG9ydGFsUGVyc29uVVVJRD4wZDU2MWIyNy1hNWUzLTQyYWItYWFhOS1kMjdiNTU5Nzc1MzY8L3BvcnRhbFBlcnNvblVVSUQ+PGRvY1NpZ25OYW1lPtCe0LEg0LjRgdC/0L7Qu9GM0LfQvtCy0LDQvdC40Lgg0LIg0J7RgtC00LXQu9C10L3QuNC4INCh0KTQoCDQv9C+INCb0LjQv9C10YbQutC+0Lkg0L7QsdC70LDRgdGC0Lgg0YHRgNC10LTRgdGC0LIg0LfQsNGJ0LjRgtGLINC40L3RhNC+0YDQvNCw0YbQuNC4PC9kb2NTaWduTmFtZT48ZG9jU2lnbkZpbGVVVUlEPjY5YTgxOWNiLWE3NmMtNDE2ZS05MTU0LTFlZWIwZWYwOTg3YTwvZG9jU2lnbkZpbGVVVUlEPjxkb2NTaWduRmlsZUhhc2hHT1NUPkIzNUJFQzQzQjU4QTdBOUM0NUM2RjQ2NkU4QTMzMjBCMzg3RTZGMjMyMzA5NDI1RDREQUFENzg1Mjg2ODAzQUM3QzU2RDY3Q0U0QkEyRjEwQTc3Njc0NTc4RTY2QUYzQTg3MDAyOUZGN0IzNjk4N0NGRDlGMzdCNjA2OTMxMjUwPC9kb2NTaWduRmlsZUhhc2hHT1NUPjxkb2NTaWduVGltZXN0YW1wPjIwMjMtMDctMjYgMDA6NTU6MTc8L2RvY1NpZ25UaW1lc3RhbXA+PC9EYXRhPjwvQm9keT48Q2VydEluZm8+PElzc3Vlcj5DTj3QmtCw0LfQvdCw0YfQtdC50YHRgtCy0L4g0KDQvtGB0YHQuNC4LCBPPdCa0LDQt9C90LDRh9C10LnRgdGC0LLQviDQoNC+0YHRgdC40LgsIEM9UlUsIEw90LMuINCc0L7RgdC60LLQsCwgU1RSRUVUPSLQkdC+0LvRjNGI0L7QuSDQl9C70LDRgtC+0YPRgdGC0LjQvdGB0LrQuNC5INC/0LXRgNC10YPQu9C+0LosINC0LiA2LCDRgdGC0YDQvtC10L3QuNC1IDEiLCDQntCT0KDQnT0xMDQ3Nzk3MDE5ODMwLCBPSUQuMS4yLjY0My4xMDAuND03NzEwNTY4NzYwLCBTPTc3INCc0L7RgdC60LLQsCwgRT11Y19ma0Byb3NrYXpuYS5ydTwvSXNzdWVyPjxTdWJqZWN0PkNOPdCf0LvQtdGI0LrQvtCyINCf0LDQstC10Lsg0JDQu9C10LrRgdCw0L3QtNGA0L7QstC40YcsIFNOPdCf0LvQtdGI0LrQvtCyLCBHPdCf0LDQstC10Lsg0JDQu9C10LrRgdCw0L3QtNGA0L7QstC40YcsIEU9cGxlc2hrb3ZwYUAwNTgucGZyLmdvdi5ydSwg0JjQndCdPTQ4MjYxODEwODAzNCwg0KHQndCY0JvQoT0xMjQxMzA4MjgwOSwgTz3Qk9Ce0KHQo9CU0JDQoNCh0KLQktCV0J3QndCe0JUg0KPQp9Cg0JXQltCU0JXQndCY0JUgLSDQntCi0JTQldCb0JXQndCY0JUg0J/QldCd0KHQmNCe0J3QndCe0JPQniDQpNCe0J3QlNCQINCg0J7QodCh0JjQmdCh0JrQntCZINCk0JXQlNCV0KDQkNCm0JjQmCDQn9CeINCb0JjQn9CV0KbQmtCe0Jkg0J7QkdCb0JDQodCi0JgsIE9VPdC+0YLQtNC10Lsg0L/QviDQt9Cw0YnQuNGC0LUg0LjQvdGE0L7RgNC80LDRhtC40LgsIFQ90LfQsNC80LXRgdGC0LjRgtC10LvRjCDQvdCw0YfQsNC70YzQvdC40LrQsCDQvtGC0LTQtdC70LAsIEw90LMu0JvQuNC/0LXRhtC6LCBTPdCb0LjQv9C10YbQutCw0Y8g0L7QsdC70LDRgdGC0YwsIEM9UlU8L1N1YmplY3Q+PFNlcmlhbD41YzAwMGM1NWViOGY5NzYwZjk5YTk0MWRmYTk5NDBiOTwvU2VyaWFsPjxOb3RCZWZvcmU+MjAyMi0wOC0yOVQwNzowMDowMFo8L05vdEJlZm9yZT48Tm90QWZ0ZXI+MjAyMy0xMS0yMlQwNzowMDowMFo8L05vdEFmdGVyPjxHb3N0PtCT0J7QodCiINCgIDM0LjExLTIwMTIvMzQuMTAtMjAxMiAyNTYg0LHQuNGCICgxLjIuNjQzLjcuMS4xLjMuMik8L0dvc3Q+PC9DZXJ0SW5mbz48U2lnbmF0dXJlIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48U2lnbmVkSW5mbz48Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPjxTaWduYXR1cmVNZXRob2QgQWxnb3JpdGhtPSJ1cm46aWV0ZjpwYXJhbXM6eG1sOm5zOmNweG1sc2VjOmFsZ29yaXRobXM6Z29zdHIzNDEwMjAxMi1nb3N0cjM0MTEyMDEyLTI1NiIvPjxSZWZlcmVuY2UgVVJJPSIiPjxUcmFuc2Zvcm1zPjxUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIvPjxUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0biMiLz48L1RyYW5zZm9ybXM+PERpZ2VzdE1ldGhvZCBBbGdvcml0aG09InVybjppZXRmOnBhcmFtczp4bWw6bnM6Y3B4bWxzZWM6YWxnb3JpdGhtczpnb3N0cjM0MTEyMDEyLTI1NiIvPjxEaWdlc3RWYWx1ZT5WcmEzdk56QWU5eGNabDErQ3JOZGpJWlRrN1poQ01XelVZaFdqSnNRREVRPTwvRGlnZXN0VmFsdWU+PC9SZWZlcmVuY2U+PC9TaWduZWRJbmZvPjxTaWduYXR1cmVWYWx1ZT5uRmdzZ3ZrbGlEZUloM1ZJQjV1Ujl5a2lES1RzTnUvSDY5UkNYNnRUVnkzNXdOWGljUkZUQmp6MnR4bGNKYk9ICkliQlNVS0pXWnFCVHVGMmxwQ3B4TFE9PTwvU2lnbmF0dXJlVmFsdWU+PEtleUluZm8+PFg1MDlEYXRhPjxYNTA5Q2VydGlmaWNhdGU+TUlJSmh6Q0NDVFNnQXdJQkFnSVFYQUFNVmV1UGwyRDVtcFFkK3BsQXVUQUtCZ2dxaFFNSEFRRURBakNDQVZjeApJREFlQmdrcWhraUc5dzBCQ1FFV0VYVmpYMlpyUUhKdmMydGhlbTVoTG5KMU1SZ3dGZ1lEVlFRSURBODNOeURRCm5OQyswWUhRdXRDeTBMQXhGVEFUQmdVcWhRTmtCQklLTnpjeE1EVTJPRGMyTURFWU1CWUdCU3FGQTJRQkVnMHgKTURRM056azNNREU1T0RNd01XQXdYZ1lEVlFRSkRGZlFrZEMrMEx2UmpOR0kwTDdRdVNEUWw5QzcwTERSZ3RDKwowWVBSZ2RHQzBMalF2ZEdCMExyUXVOQzVJTkMvMExYUmdOQzEwWVBRdTlDKzBMb3NJTkMwTGlBMkxDRFJnZEdDCjBZRFF2dEMxMEwzUXVOQzFJREV4R1RBWEJnTlZCQWNNRU5DekxpRFFuTkMrMFlIUXV0Q3kwTEF4Q3pBSkJnTlYKQkFZVEFsSlZNUzR3TEFZRFZRUUtEQ1hRbXRDdzBMZlF2ZEN3MFlmUXRkQzUwWUhSZ3RDeTBMNGcwS0RRdnRHQgowWUhRdU5DNE1TNHdMQVlEVlFRRERDWFFtdEN3MExmUXZkQ3cwWWZRdGRDNTBZSFJndEN5MEw0ZzBLRFF2dEdCCjBZSFF1TkM0TUI0WERUSXlNRGd5T1RBM01EQXdNRm9YRFRJek1URXlNakEzTURBd01Gb3dnZ0o3TVFzd0NRWUQKVlFRR0V3SlNWVEVvTUNZR0ExVUVDQXdmMEp2UXVOQy8wTFhSaHRDNjBMRFJqeURRdnRDeDBMdlFzTkdCMFlMUgpqREVZTUJZR0ExVUVCd3dQMExNdTBKdlF1TkMvMExYUmh0QzZNVUV3UHdZRFZRUU1ERGpRdDlDdzBMelF0ZEdCCjBZTFF1TkdDMExYUXU5R01JTkM5MExEUmg5Q3cwTHZSak5DOTBMalF1dEN3SU5DKzBZTFF0TkMxMEx2UXNERTYKTURnR0ExVUVDd3d4MEw3Umd0QzAwTFhRdXlEUXY5QytJTkMzMExEUmlkQzQwWUxRdFNEUXVOQzkwWVRRdnRHQQowTHpRc05HRzBMalF1REdCd2pDQnZ3WURWUVFLRElHMzBKUFFudENoMEtQUWxOQ1EwS0RRb2RDaTBKTFFsZENkCjBKM1FudENWSU5DajBLZlFvTkNWMEpiUWxOQ1YwSjNRbU5DVklDMGcwSjdRb3RDVTBKWFFtOUNWMEozUW1OQ1YKSU5DZjBKWFFuZENoMEpqUW50Q2QwSjNRbnRDVDBKNGcwS1RRbnRDZDBKVFFrQ0RRb05DZTBLSFFvZENZMEpuUQpvZENhMEo3UW1TRFFwTkNWMEpUUWxkQ2cwSkRRcHRDWTBKZ2cwSi9RbmlEUW05Q1kwSi9RbGRDbTBKclFudENaCklOQ2UwSkhRbTlDUTBLSFFvdENZTVJZd0ZBWUZLb1VEWkFNU0N6RXlOREV6TURneU9EQTVNUm93R0FZSUtvVUQKQTRFREFRRVNERFE0TWpZeE9ERXdPREF6TkRFb01DWUdDU3FHU0liM0RRRUpBUllaY0d4bGMyaHJiM1p3WVVBdwpOVGd1Y0daeUxtZHZkaTV5ZFRFdU1Dd0dBMVVFS2d3bDBKL1FzTkN5MExYUXV5RFFrTkM3MExYUXV0R0IwTERRCnZkQzAwWURRdnRDeTBMalJoekVYTUJVR0ExVUVCQXdPMEovUXU5QzEwWWpRdXRDKzBMSXhQVEE3QmdOVkJBTU0KTk5DZjBMdlF0ZEdJMExyUXZ0Q3lJTkNmMExEUXN0QzEwTHNnMEpEUXU5QzEwTHJSZ2RDdzBMM1F0TkdBMEw3UQpzdEM0MFljd1pqQWZCZ2dxaFFNSEFRRUJBVEFUQmdjcWhRTUNBaVFBQmdncWhRTUhBUUVDQWdOREFBUkFEOEtJClJ1cWM1d3kxN1phRHdmNEZPU1JsU3VDNDRlVElHVTR5azFCWXk2aTV4bmNoMDJ2YnpIbXBBcWhRa2F3YjhIdFYKdDNIZXF1d0NPNFN5c1hreVU2T0NCS3N3Z2dTbk1BNEdBMVVkRHdFQi93UUVBd0lEK0RBeEJnTlZIU1VFS2pBbwpCZ2dyQmdFRkJRY0RBZ1lJS3dZQkJRVUhBd1FHQ0NxRkF3SUJCZ2dGQmdncWhRTURnWHNCQVRBZEJnTlZIU0FFCkZqQVVNQWdHQmlxRkEyUnhBVEFJQmdZcWhRTmtjUUl3REFZRktvVURaSElFQXdJQkFUQXRCZ1VxaFFOa2J3UWsKRENMUW10R0EwTGpRdjlHQzBMN1FuOUdBMEw0Z1ExTlFJQ2cxTGpBdU1URTBOVFVwTUlJQmlRWUZLb1VEWkhBRQpnZ0YrTUlJQmVneUJoOUNmMFlEUXZ0Q3owWURRc05DODBMelF2ZEMrTGRDdzBML1F2OUN3MFlEUXNOR0MwTDNSCmk5QzVJTkM2MEw3UXZOQy8wTHZRdGRDNjBZRWdWbWxRVG1WMElGQkxTU0JUWlhKMmFXTmxJQ2pRdmRDd0lOQ3cKMEwvUXY5Q3cwWURRc05HQzBMM1F2dEM1SU5DLzBMdlFzTkdDMFlUUXZ0R0EwTHpRdFNCSVUwMGdNakF3TUZFeQpLUXhvMEovUmdOQyswTFBSZ05DdzBMelF2TkM5MEw0dDBMRFF2OUMvMExEUmdOQ3cwWUxRdmRHTDBMa2cwTHJRCnZ0QzgwTC9RdTlDMTBMclJnU0RDcTlDdTBMM1F1TkdCMExYUmdOR0NMZENUMEo3UW9kQ2l3cnN1SU5DUzBMWFIKZ05HQjBMalJqeUEwTGpBTVR0Q2gwTFhSZ05HQzBMalJoTkM0MExyUXNOR0NJTkdCMEw3UXZ0R0MwTExRdGRHQwowWUhSZ3RDeTBMalJqeURpaEpiUW9kQ2tMekV5TkMwek56UXpJTkMrMFlJZ01EUXVNRGt1TWpBeE9RdzAwSmZRCnNOQzYwTHZSanRHSDBMWFF2ZEM0MExVZzRvU1dJREUwT1M4M0x6WXZORFV5SU5DKzBZSWdNekF1TVRJdU1qQXkKTVRCbUJnTlZIUjhFWHpCZE1DNmdMS0FxaGlob2RIUndPaTh2WTNKc0xuSnZjMnRoZW01aExuSjFMMk55YkM5MQpZMlpyWHpJd01qSXVZM0pzTUN1Z0thQW5oaVZvZEhSd09pOHZZM0pzTG1ackxteHZZMkZzTDJOeWJDOTFZMlpyClh6SXdNakl1WTNKc01IY0dDQ3NHQVFVRkJ3RUJCR3N3YVRBMEJnZ3JCZ0VGQlFjd0FvWW9hSFIwY0RvdkwyTnkKYkM1eWIzTnJZWHB1WVM1eWRTOWpjbXd2ZFdObWExOHlNREl5TG1OeWREQXhCZ2dyQmdFRkJRY3dBb1lsYUhSMApjRG92TDJOeWJDNW1heTVzYjJOaGJDOWpjbXd2ZFdObWExOHlNREl5TG1OeWREQWRCZ05WSFE0RUZnUVV2SHNOCjJwb3I0QUpNRytWWkNweURjTytTTThzd2dnRjNCZ05WSFNNRWdnRnVNSUlCYW9BVUhZQW0wb2xpNXdTQmp4NUsKNkt0eWtuWXQzVDJoZ2dGRHBJSUJQekNDQVRzeElUQWZCZ2txaGtpRzl3MEJDUUVXRW1ScGRFQmthV2RwZEdGcwpMbWR2ZGk1eWRURUxNQWtHQTFVRUJoTUNVbFV4R0RBV0JnTlZCQWdNRHpjM0lOQ2MwTDdSZ2RDNjBMTFFzREVaCk1CY0dBMVVFQnd3UTBMTXVJTkNjMEw3UmdkQzYwTExRc0RGVE1GRUdBMVVFQ1F4SzBKL1JnTkMxMFlIUXZkQzEKMEwzUmdkQzYwTERSanlEUXZkQ3cwTEhRdGRHQTBMWFF0dEM5MExEUmp5d2cwTFRRdnRDOElERXdMQ0RSZ2RHQwowWURRdnRDMTBMM1F1TkMxSURJeEpqQWtCZ05WQkFvTUhkQ2MwTGpRdmRHRzBMalJoTkdBMFlzZzBLRFF2dEdCCjBZSFF1TkM0TVJnd0ZnWUZLb1VEWkFFU0RURXdORGMzTURJd01qWTNNREV4RlRBVEJnVXFoUU5rQkJJS056Y3gKTURRM05ETTNOVEVtTUNRR0ExVUVBd3dkMEp6UXVOQzkwWWJRdU5HRTBZRFJpeURRb05DKzBZSFJnZEM0MExpQwpDd0RQNlA5aEFBQUFBQVgyTUFvR0NDcUZBd2NCQVFNQ0EwRUFnNGFhUEVWOGh2dlNEeU9rRTBxSkg2eUt5c2NxCjJOMGx4QkQ2ZlE1UjhRcG85cnYvcUlORERtbWdFZ1dBZEl3aFNSZlJoMGlhSW5RTE9RRFByeC9rNGc9PTwvWDUwOUNlcnRpZmljYXRlPjxYNTA5U3ViamVjdE5hbWU+Q0490J/Qu9C10YjQutC+0LIg0J/QsNCy0LXQuyDQkNC70LXQutGB0LDQvdC00YDQvtCy0LjRhywgU0490J/Qu9C10YjQutC+0LIsIEc90J/QsNCy0LXQuyDQkNC70LXQutGB0LDQvdC00YDQvtCy0LjRhywgRT1wbGVzaGtvdnBhQDA1OC5wZnIuZ292LnJ1LCDQmNCd0J09NDgyNjE4MTA4MDM0LCDQodCd0JjQm9ChPTEyNDEzMDgyODA5LCBPPdCT0J7QodCj0JTQkNCg0KHQotCS0JXQndCd0J7QlSDQo9Cn0KDQldCW0JTQldCd0JjQlSAtINCe0KLQlNCV0JvQldCd0JjQlSDQn9CV0J3QodCY0J7QndCd0J7Qk9CeINCk0J7QndCU0JAg0KDQntCh0KHQmNCZ0KHQmtCe0Jkg0KTQldCU0JXQoNCQ0KbQmNCYINCf0J4g0JvQmNCf0JXQptCa0J7QmSDQntCR0JvQkNCh0KLQmCwgT1U90L7RgtC00LXQuyDQv9C+INC30LDRidC40YLQtSDQuNC90YTQvtGA0LzQsNGG0LjQuCwgVD3Qt9Cw0LzQtdGB0YLQuNGC0LXQu9GMINC90LDRh9Cw0LvRjNC90LjQutCwINC+0YLQtNC10LvQsCwgTD3Qsy7Qm9C40L/QtdGG0LosIFM90JvQuNC/0LXRhtC60LDRjyDQvtCx0LvQsNGB0YLRjCwgQz1SVTwvWDUwOVN1YmplY3ROYW1lPjxYNTA5SXNzdWVyU2VyaWFsPjxYNTA5SXNzdWVyTmFtZT5DTj3QmtCw0LfQvdCw0YfQtdC50YHRgtCy0L4g0KDQvtGB0YHQuNC4LCBPPdCa0LDQt9C90LDRh9C10LnRgdGC0LLQviDQoNC+0YHRgdC40LgsIEM9UlUsIEw90LMuINCc0L7RgdC60LLQsCwgU1RSRUVUPSLQkdC+0LvRjNGI0L7QuSDQl9C70LDRgtC+0YPRgdGC0LjQvdGB0LrQuNC5INC/0LXRgNC10YPQu9C+0LosINC0LiA2LCDRgdGC0YDQvtC10L3QuNC1IDEiLCDQntCT0KDQnT0xMDQ3Nzk3MDE5ODMwLCBPSUQuMS4yLjY0My4xMDAuND03NzEwNTY4NzYwLCBTPTc3INCc0L7RgdC60LLQsCwgRT11Y19ma0Byb3NrYXpuYS5ydTwvWDUwOUlzc3Vlck5hbWU+PFg1MDlTZXJpYWxOdW1iZXI+MTIyMjg5MjI1ODA4NDIzODg2NDA2MDk3MjEwNzk3MjMwNDczNDAxPC9YNTA5U2VyaWFsTnVtYmVyPjwvWDUwOUlzc3VlclNlcmlhbD48WDUwOVNLST52SHNOMnBvcjRBSk1HK1ZaQ3B5RGNPK1NNOHM9PC9YNTA5U0tJPjwvWDUwOURhdGE+PC9LZXlJbmZvPjwvU2lnbmF0dXJlPjwvRW52ZWxvcGU+Cg==";
        $xmlToCheck = base64_decode($xmldata);
        $this->interface->checkSignXML($xmlToCheck);
        //$this->signXMLUnep();
        //$this->getAllCertsToDB();

        dump('done');
    }

    public function gostHashFile(string $filename, string $disk = 'docsfiles')
    {
        $filedata = Storage::disk($disk)->get($filename);
        if (!empty($filename)) {
            $gostHash = $this->interface->gostHashFile($filedata);
            return $gostHash;
        }
        return null;
    }

    public function gostCheckHashFile(string $filename, string $hash, string $disk = 'docsfiles')
    {
        $filedata = Storage::disk($disk)->get($filename);
        if ((!empty($filename)) && (!empty($hash))) {
            $gostHash = $this->interface->gostCheckHashFile($filedata, $hash);
            return $gostHash;
        }
        return false;
    }


    public function getAllCertsToDB()
    {

        $allCertsCollection = $this->interface->getAllCertsFromStorage();
        $allCertsCollection->each(function ($item) {
            $certDTO = $this->interface->parceCertToDTO($item);
            $pid = $this->searchPidBySnils($certDTO->Snils);
            //dump($person, $certDTO->Snils);
            $this->interface->saveCertToDB($certDTO, $pid);
        });
        //TODO: добавить логгирование

    }

    public function signXMLUnep(string $xmlToSign, int $unepCertID)
    {
        return $this->interface->signXML(base64_decode($xmlToSign), CertsTypesEnum::UNEP(), $unepCertID);
    }
}
